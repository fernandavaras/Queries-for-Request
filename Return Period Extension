SELECT OH.ORDER_ID,
          OH.CUST_ID,
          CP.SUPPLIER_CBN,
          S.QTY_DECLARED_PACKING,
          OD.PART_ORDERED,
          P.PART_DESCRIPTION,
          OH.RMA_NUMBER,
          OH.PO_NUMBER,
          OD.LINE_NUMBER,
          NVL ( (S.SHIPMENT_NUMBER), 0) AS SHIP_NUM,
          NVL ( (S.QTY_SHIPPED), 0) AS QS,
          NVL ( (S.QTY_SHIPPED - S.QTY_DECLARED_PACKING), 0) AS QSTR,
          NVL ( (S.SHIPMENT_DATE), NULL) AS SHIPMENT_DATE,
          NVL ( (S.SHIPMENT_DATE + CP.RETURN_PERIOD), NULL)
             AS DEFECTIVE_EXPIRY_DATE,
          OH.SUPPLIER_ID
     FROM WIZADMIN.ORDER_HEADER OH,
          WIZADMIN.ORDER_DETAIL OD,
          WIZADMIN.COMPANY_PROFILE CP,
          WIZADMIN.PART_INFO P,
          WIZADMIN.SHIPMENT S
    WHERE     OH.CUST_ID = CP.CUST_ID
          AND OH.ORDER_ID = OD.ORDER_ID
          AND S.ORDER_ID = OD.ORDER_ID
          AND OD.LINE_NUMBER = S.LINE_NUMBER
          AND P.PART_NUMBER = OD.PART_ORDERED
          AND OD.STATUS NOT IN
                 ('ORDDSTAT_DRAFT',
                  'ORDDSTAT_CANCELLED',
                  'ORDDSTAT_WARNING',
                  'ORDDSTAT_IN_PROCESS')
          AND OD.DEFECTIVE_RETURN_FLAG = 'Y'
          AND CP.DEFECTIVE_RETURN_FLAG = 'Y'
          AND S.SHIPMENT_DATE >= TRUNC (SYSDATE) - CP.RETURN_PERIOD
          AND S.QTY_DECLARED_PACKING <= S.QTY_SHIPPED
          AND CP.SUPPLIER_CBN <> 'CCEXP' AND CP.SUPPLIER_CBN <> 'CCEXPRM' AND CP.SUPPLIER_CBN <> 'BDHOOW';
 
